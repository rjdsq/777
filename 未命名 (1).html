<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub文件管理器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6b7280',
                        secondary: '#4b5563',
                        dark: '#111827',
                        darker: '#030712',
                        light: '#f3f4f6',
                        success: '#0f5132',
                        successLight: '#d1e7dd',
                        error: '#842029',
                        errorLight: '#f8d7da',
                        info: '#084298',
                        infoLight: '#e9f5ff',
                        modified: '#3b82f6',
                        modifiedLight: '#dbeafe'
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .glass {
                background: rgba(17, 24, 39, 0.8);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }
            .neumorph {
                box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.3),
                           -5px -5px 10px rgba(75, 85, 99, 0.1);
            }
            .neumorph-inset {
                box-shadow: inset 3px 3px 6px rgba(0, 0, 0, 0.3),
                           inset -3px -3px 6px rgba(75, 85, 99, 0.1);
            }
            .file-icon {
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 8px;
            }
            .upload-progress {
                height: 4px;
                background-color: rgba(75, 85, 99, 0.3);
                border-radius: 2px;
                overflow: hidden;
            }
            .upload-bar {
                height: 100%;
                background-color: #6b7280;
                width: 0%;
                transition: width 0.3s ease;
            }
            .status {
                padding: 0.75rem;
                margin: 0.75rem 0;
                border-radius: 0.375rem;
            }
            .editor-placeholder {
                color: #9ca3af;
                pointer-events: none;
                position: absolute;
                margin: 1rem;
            }
        }
    </style>
</head>
<body class="bg-darker text-light min-h-screen overflow-x-hidden">
    <div id="loadingOverlay" class="fixed inset-0 bg-black/30 z-30 hidden items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-gray-400"></div>
    </div>
    <div id="authScreen" class="h-screen flex flex-col p-6 justify-center gap-6">
        <div class="text-center mb-10">
            <i class="fa fa-github text-6xl text-gray-400 mb-4"></i>
            <h1 class="text-3xl font-bold">GitHub文件管理器</h1>
        </div>
        <div class="neumorph bg-dark rounded rounded rounded-xl p-6 flex flex-col gap-4">
            <input type="text" id="tokenInput" placeholder="输入GitHub访问令牌" 
                class="neumorph-inset bg-darker rounded-lg p-3 outline-none text-light">
            <button id="authBtn" class="neumorph bg-primary hover:bg-secondary transition-colors rounded-lg p-3 font-medium">
                登录
            </button>
        </div>
    </div>

    <div id="app" class="hidden flex flex-col h-screen">
        <header class="glass neumorph py-3 px-4 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fa fa-github text-gray-400"></i>
                <h1 class="font-bold text-lg truncate" id="currentRepo">选择仓库</h1>
            </div>
            <button id="logoutBtn" class="p-2 rounded-full hover:bg-primary/20 transition-colors" title="退出登录">
                <i class="fa fa-sign-out"></i>
            </button>
        </header>

        <div class="glass py-2 px-4 overflow-x-auto whitespace-nowrap hidden" id="pathNavContainer">
            <div id="pathNav" class="flex gap-1 text-sm">
                <span class="path-item cursor-pointer">/</span>
            </div>
        </div>

        <main id="fileList" class="flex-1 overflow-y-auto p-3 space-y-2">
            <div class="flex justify-center items-center h-full">
                <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-gray-400"></div>
            </div>
        </main>

        <footer class="glass neumorph py-3 px-4 flex justify-around">
            <button id="backBtn" class="flex flex-col items-center justify-center p-2 w-1/5" title="返回上级">
                <i class="fa fa-arrow-up text-xl"></i>
            </button>
            <button id="newFolderBtn" class="flex flex-col items-center justify-center p-2 w-1/5" title="新建文件夹">
                <i class="fa fa-folder text-xl"></i>
            </button>
            <button id="uploadBtn" class="flex flex-col items-center justify-center p-2 w-1/5" title="上传文件">
                <i class="fa fa-upload text-xl"></i>
            </button>
            <button id="refreshBtn" class="flex flex-col items-center justify-center p-2 w-1/5" title="刷新">
                <i class="fa fa-refresh text-xl"></i>
            </button>
            <button id="repoBtn" class="flex flex-col items-center justify-center p-2 w-1/5" title="仓库列表">
                <i class="fa fa-github text-xl"></i>
            </button>
        </footer>
    </div>

    <div id="repoSelectModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
        <div class="neumorph bg-dark rounded-xl p-5 w-11/12 max-w-md max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">选择仓库</h3>
                <button id="closeRepoModal" class="p-2 hover:bg-primary/20 rounded-full">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div id="repoListContainer">
                <div class="flex justify-center items-center py-10">
                    <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-gray-400"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="editModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
        <div class="neumorph bg-dark rounded-xl p-5 w-11/12 max-w-3xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold" id="editFileName">编辑文件</h3>
                <button id="closeEditModal" class="p-2 hover:bg-primary/20 rounded-full">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <div class="status" id="editStatus">准备就绪</div>
            
            <div class="relative flex-1 min-h-[300px] mt-2">
                <div id="editorPlaceholder" class="editor-placeholder hidden">加载中...</div>
                <textarea id="fileContent" class="neumorph-inset bg-darker rounded-lg p-3 outline-none text-light w-full h-full resize-none"></textarea>
            </div>
            
            <div class="flex gap-2 mt-4">
                <button id="cancelEdit" class="flex-1 neumorph bg-dark hover:bg-dark/70 transition-colors rounded-lg p-2">取消</button>
                <button id="saveEdit" class="flex-1 neumorph bg-primary hover:bg-secondary transition-colors rounded-lg p-2">保存修改</button>
            </div>
        </div>
    </div>

    <div id="uploadPanel" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 glass neumorph rounded-lg p-4 w-11/12 max-w-md hidden z-40">
        <h3 class="font-medium mb-3">文件上传中</h3>
        <div id="uploadItems" class="space-y-3 max-h-40 overflow-y-auto">
        </div>
    </div>

    <div id="modalOverlay" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
        <div class="neumorph bg-dark rounded-xl p-5 w-11/12 max-w-md">
            <div id="modalContent"></div>
        </div>
    </div>

    <div id="contextMenu" class="fixed glass neumorph rounded-lg shadow-lg z-50 hidden w-48">
        <div class="py-1">
            <a class="context-menu-item block px-4 py-2 text-sm hover:bg-primary/20" data-action="download">
                <i class="fa fa-download mr-2"></i>下载
            </a>
            <a class="context-menu-item block px-4 py-2 text-sm hover:bg-primary/20" data-action="copyLink">
                <i class="fa fa-link mr-2"></i>复制链接
            </a>
            <a class="context-menu-item block px-4 py-2 text-sm hover:bg-primary/20" data-action="copyProxy">
                <i class="fa fa-share mr-2"></i>代理链接
            </a>
            <a class="context-menu-item block px-4 py-2 text-sm hover:bg-primary/20" data-action="edit">
                <i class="fa fa-edit mr-2"></i>编辑
            </a>
            <a class="context-menu-item block px-4 py-2 text-sm hover:bg-primary/20 text-red-400" data-action="delete">
                <i class="fa fa-trash mr-2"></i>删除
            </a>
        </div>
    </div>

    <div id="toast" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 glass neumorph px-4 py-2 rounded-full hidden z-30">
        <span id="toastMessage"></span>
    </div>

    <script>
        const state = {
            token: localStorage.getItem('gh_token') || null,
            currentRepo: null,
            currentPath: '',
            files: [],
            repos: [],
            selectedFile: null,
            uploadQueue: [],
            editingFile: null,
            fileSha: '',
            originalContent: '',
            lastRequestTime: 0,
            MIN_INTERVAL: 1000
        };

        const elements = {
            authScreen: document.getElementById('authScreen'),
            app: document.getElementById('app'),
            tokenInput: document.getElementById('tokenInput'),
            authBtn: document.getElementById('authBtn'),
            fileList: document.getElementById('fileList'),
            pathNav: document.getElementById('pathNav'),
            pathNavContainer: document.getElementById('pathNavContainer'),
            currentRepo: document.getElementById('currentRepo'),
            logoutBtn: document.getElementById('logoutBtn'),
            newFolderBtn: document.getElementById('newFolderBtn'),
            uploadBtn: document.getElementById('uploadBtn'),
            refreshBtn: document.getElementById('refreshBtn'),
            repoBtn: document.getElementById('repoBtn'),
            backBtn: document.getElementById('backBtn'),
            modalOverlay: document.getElementById('modalOverlay'),
            modalContent: document.getElementById('modalContent'),
            contextMenu: document.getElementById('contextMenu'),
            toast: document.getElementById('toast'),
            toastMessage: document.getElementById('toastMessage'),
            uploadPanel: document.getElementById('uploadPanel'),
            uploadItems: document.getElementById('uploadItems'),
            editModal: document.getElementById('editModal'),
            editFileName: document.getElementById('editFileName'),
            fileContent: document.getElementById('fileContent'),
            editorPlaceholder: document.getElementById('editorPlaceholder'),
            closeEditModal: document.getElementById('closeEditModal'),
            cancelEdit: document.getElementById('cancelEdit'),
            saveEdit: document.getElementById('saveEdit'),
            editStatus: document.getElementById('editStatus'),
            repoSelectModal: document.getElementById('repoSelectModal'),
            repoListContainer: document.getElementById('repoListContainer'),
            closeRepoModal: document.getElementById('closeRepoModal'),
            loadingOverlay: document.getElementById('loadingOverlay')
        };

        init();

        function init() {
            if (state.token) {
                showApp();
                fetchRepos();
            } else {
                showAuth();
            }
            setupEventListeners();
        }

        function showAuth() {
            elements.authScreen.classList.remove('hidden');
            elements.app.classList.add('hidden');
        }

        function showApp() {
            elements.authScreen.classList.add('hidden');
            elements.app.classList.remove('hidden');
        }

        async function fetchRepos() {
            try {
                const res = await fetch('https://api.github.com/user/repos', {
                    headers: { 
                        Authorization: `token ${state.token}`,
                        'User-Agent': 'Mozilla/5.0'
                    }
                });
                
                if (!res.ok) {
                    throw new Error('获取仓库失败');
                }
                
                state.repos = await res.json();
                
                if (state.repos.length > 0 && !state.currentRepo) {
                    state.currentRepo = state.repos[0].full_name;
                    elements.currentRepo.textContent = state.repos[0].name;
                    elements.pathNavContainer.classList.remove('hidden');
                    renderPathNav();
                    fetchFiles();
                }
                
                renderRepoListInModal();
            } catch (err) {
                showToast('加载仓库失败');
                console.error(err);
            }
        }

        function renderRepoListInModal() {
            elements.repoListContainer.innerHTML = '';
            
            if (state.repos.length === 0) {
                elements.repoListContainer.innerHTML = `
                    <div class="text-center py-10 text-gray-400">
                        <i class="fa fa-github text-4xl mb-2"></i>
                        <p>没有找到仓库</p>
                    </div>
                `;
                return;
            }

            state.repos.forEach(repo => {
                const item = document.createElement('div');
                item.className = `neumorph bg-dark rounded-lg p-3 flex items-center gap-3 hover:bg-primary/10 transition-colors cursor-pointer ${state.currentRepo === repo.full_name ? 'ring-2 ring-blue-500' : ''}`;
                item.innerHTML = `
                    <div class="file-icon bg-dark/50">
                        <i class="fa fa-github text-gray-400"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="font-medium truncate">${repo.name}<p class="font-medium truncate">${repo.name}</p>
                        <p class="text-xs text-gray-400">${repo.full_name}</p>
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    state.currentRepo = repo.full_name;
                    state.currentPath = '';
                    elements.currentRepo.textContent = repo.name;
                    elements.pathNavContainer.classList.remove('hidden');
                    renderPathNav();
                    fetchFiles();
                    hideRepoSelectModal();
                });
                
                elements.repoListContainer.appendChild(item);
            });
        }

        async function fetchFiles() {
            if (!state.currentRepo) return;
            
            try {
                const url = `https://api.github.com/repos/${state.currentRepo}/contents/${state.currentPath}`;
                const res = await fetch(url, {
                    headers: { 
                        Authorization: `token ${state.token}`,
                        'User-Agent': 'Mozilla/5.0'
                    }
                });
                
                if (!res.ok) {
                    showToast('加载文件失败');
                    return;
                }
                
                state.files = await res.json();
                sortFiles();
                renderFileList();
                hideLoading();
            } catch (err) {
                showToast('加载文件失败');
                console.error(err);
                hideLoading();
            }
        }

        function sortFiles() {
            state.files.sort((a, b) => {
                if (a.type === 'dir' && b.type !== 'dir') return -1;
                if (a.type !== 'dir' && b.type === 'dir') return 1;
                
                const dateA = new Date(a.updated_at).getTime();
                const dateB = new Date(b.updated_at).getTime();
                return dateA - dateB;
            });
        }

        function renderFileList() {
            elements.fileList.innerHTML = '';
            
            if (state.files.length === 0) {
                elements.fileList.innerHTML = `
                    <div class="text-center py-10 text-gray-400">
                        <i class="fa fa-folder-open-o text-4xl mb-2"></i>
                        <p>文件夹为空</p>
                    </div>
                `;
                return;
            }

            state.files.forEach(file => {
                const isDir = file.type === 'dir';
                const icon = isDir ? 'fa-folder text-yellow-500' : getFileIcon(file.name);
                
                const item = document.createElement('div');
                item.className = 'neumorph bg-dark rounded-lg p-3 flex items-center gap-3 hover:bg-primary/10 transition-colors cursor-pointer';
                item.innerHTML = `
                    <div class="file-icon bg-dark/50">
                        <i class="fa ${icon}"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="font-medium truncate">${file.name}</p>
                        <p class="text-xs text-gray-400">
                            ${isDir ? '文件夹' : formatSize(file.size)} 
                            · ${formatRelativeTime(new Date(file.updated_at))}
                        </p>
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    if (isDir) {
                        navigateToDir(file.name);
                    } else {
                        editFile(file);
                    }
                });
                
                let pressTimer;
                item.addEventListener('touchstart', (e) => {
                    pressTimer = setTimeout(() => {
                        e.preventDefault();
                        showContextMenu(e, file);
                    }, 500);
                });
                
                item.addEventListener('touchend', () => {
                    clearTimeout(pressTimer);
                });
                
                item.addEventListener('touchcancel', () => {
                    clearTimeout(pressTimer);
                });
                
                item.addEventListener('mousedown', (e) => {
                    pressTimer = setTimeout(() => {
                        e.preventDefault();
                        showContextMenu(e, file);
                    }, 500);
                });
                
                item.addEventListener('mouseup', () => {
                    clearTimeout(pressTimer);
                });
                
                item.addEventListener('mouseleave', () => {
                    clearTimeout(pressTimer);
                });
                
                elements.fileList.appendChild(item);
            });
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            switch(ext) {
                case 'html': return 'fa-html5 text-orange-500';
                case 'css': return 'fa-css3 text-blue-500';
                case 'js': return 'fa-code text-yellow-500';
                case 'json': return 'fa-file-code-o text-gray-400';
                case 'md': return 'fa-file-text-o text-blue-400';
                case 'jpg':
                case 'jpeg':
                case 'png':
                case 'gif':
                case 'svg': return 'fa-file-image-o text-green-500';
                case 'pdf': return 'fa-file-pdf-o text-red-500';
                case 'zip':
                case 'rar':
                case 'tar':
                case 'gz': return 'fa-file-archive-o text-purple-500';
                case 'txt': return 'fa-file-text-o text-gray-400';
                default: return 'fa-file-o text-gray-400';
            }
        }

        function formatSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatRelativeTime(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffSecs = Math.floor(diffMs / 1000);
            const diffMins = Math.floor(diffSecs / 60);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffSecs < 60) return `${diffSecs}秒前`;
            if (diffMins < 60) return `${diffMins}分钟前`;
            if (diffHours < 24) return `${diffHours}小时前`;
            if (diffDays < 30) return `${diffDays}天前`;
            
            return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
        }

        function renderPathNav() {
            elements.pathNav.innerHTML = '';
            
            const homeItem = document.createElement('span');
            homeItem.className = 'path-item cursor-pointer';
            homeItem.textContent = '/';
            homeItem.addEventListener('click', () => {
                if (state.currentPath !== '') {
                    state.currentPath = '';
                    showLoading();
                    fetchFiles();
                }
            });
            elements.pathNav.appendChild(homeItem);
            
            if (!state.currentPath) return;
            
            const pathParts = state.currentPath.split('/');
            let currentPath = '';
            
            pathParts.forEach((part, index) => {
                if (!part) return;
                
                const separator = document.createElement('span');
                separator.textContent = '/';
                elements.pathNav.appendChild(separator);
                
                const pathItem = document.createElement('span');
                pathItem.className = 'path-item cursor-pointer';
                pathItem.textContent = part;
                
                currentPath += part + (index < pathParts.length - 1 ? '/' : '');
                const pathToNavigate = currentPath;
                
                pathItem.addEventListener('click', () => {
                    if (state.currentPath !== pathToNavigate) {
                        state.currentPath = pathToNavigate;
                        showLoading();
                        fetchFiles();
                    }
                });
                
                elements.pathNav.appendChild(pathItem);
            });
        }

        function navigateToDir(dirName) {
            showLoading();
            if (state.currentPath) {
                state.currentPath += '/' + dirName;
            } else {
                state.currentPath = dirName;
            }
            renderPathNav();
            fetchFiles();
        }

        async function editFile(file) {
            state.editingFile = file;
            elements.editFileName.textContent = file.name;
            elements.fileContent.value = '';
            elements.editorPlaceholder.classList.remove('hidden');
            elements.editStatus.textContent = '加载中...';
            elements.editStatus.className = 'status bg-infoLight text-info';
            
            try {
                const res = await fetch(file.download_url, {
                    headers: {
                        Authorization: `token ${state.token}`,
                        'User-Agent': 'Mozilla/5.0'
                    }
                });
                
                if (!res.ok) {
                    throw new Error('文件加载失败');
                }
                
                const content = await res.text();
                state.originalContent = content;
                elements.fileContent.value = content;
                elements.editorPlaceholder.classList.add('hidden');
                elements.editStatus.textContent = '准备就绪';
                elements.editStatus.className = 'status bg-dark';
                state.fileSha = file.sha;
                
                showEditModal();
            } catch (err) {
                elements.editStatus.textContent = '加载失败';
                elements.editStatus.className = 'status bg-errorLight text-error';
                console.error(err);
            }
        }

        async function saveFileChanges() {
            if (!state.editingFile || !state.currentRepo) return;
            
            const newContent = elements.fileContent.value;
            if (newContent === state.originalContent) {
                showToast('内容未修改');
                return;
            }
            
            elements.saveEdit.disabled = true;
            elements.editStatus.textContent = '保存中...';
            elements.editStatus.className = 'status bg-infoLight text-info';
            
            try {
                const encodedContent = btoa(unescape(encodeURIComponent(newContent)));
                const url = `https://api.github.com/repos/${state.currentRepo}/contents/${state.currentPath ? state.currentPath + '/' : ''}${state.editingFile.name}`;
                
                const res = await fetchWithRateLimit(url, {
                    method: 'PUT',
                    headers: {
                        Authorization: `token ${state.token}`,
                        'Content-Type': 'application/json',
                        'User-Agent': 'Mozilla/5.0'
                    },
                    body: JSON.stringify({
                        message: `Update ${state.editingFile.name}`,
                        content: encodedContent,
                        sha: state.fileSha
                    })
                });
                
                if (!res.ok) {
                    throw new Error('保存失败');
                }
                
                elements.editStatus.textContent = '保存成功';
                elements.editStatus.className = 'status bg-successLight text-success';
                state.originalContent = newContent;
                showToast('文件已保存');
                hideEditModal();
                fetchFiles();
            } catch (err) {
                elements.editStatus.textContent = '保存失败';
                elements.editStatus.className = 'status bg-errorLight text-error';
                console.error(err);
            } finally {
                elements.saveEdit.disabled = false;
            }
        }

        function showEditModal() {
            elements.editModal.classList.remove('hidden');
            elements.editModal.classList.add('flex');
        }

        function hideEditModal() {
            elements.editModal.classList.add('hidden');
            elements.editModal.classList.remove('flex');
        }

        function showRepoSelectModal() {
            elements.repoSelectModal.classList.remove('hidden');
            elements.repoSelectModal.classList.add('flex');
        }

        function hideRepoSelectModal() {
            elements.repoSelectModal.classList.add('hidden');
            elements.repoSelectModal.classList.remove('flex');
        }

        function showContextMenu(e, file) {
            e.preventDefault();
            state.selectedFile = file;
            
            const x = e.clientX || e.touches[0].clientX;
            const y = e.clientY || e.touches[0].clientY;
            
            elements.contextMenu.style.left = `${x}px`;
            elements.contextMenu.style.top = `${y}px`;
            elements.contextMenu.classList.remove('hidden');
            
            document.querySelectorAll('.context-menu-item').forEach(item => {
                item.addEventListener('click', handleContextMenuAction);
            });
        }

        function hideContextMenu() {
            elements.contextMenu.classList.add('hidden');
            document.querySelectorAll('.context-menu-item').forEach(item => {
                item.removeEventListener('click', handleContextMenuAction);
            });
        }

        function handleContextMenuAction(e) {
            e.preventDefault();
            const action = e.currentTarget.dataset.action;
            const file = state.selectedFile;
            
            if (action === 'download' && file.download_url) {
                window.open(file.download_url, '_blank');
            } else if (action === 'copyLink' && file.html_url) {
                navigator.clipboard.writeText(file.html_url).then(() => {
                    showToast('链接已复制');
                });
            } else if (action === 'copyProxy' && file.download_url) {
                const proxyUrl = `https://ghproxy.com/${file.download_url}`;
                navigator.clipboard.writeText(proxyUrl).then(() => {
                    showToast('代理链接已复制');
                });
            } else if (action === 'edit') {
                editFile(file);
            } else if (action === 'delete') {
                confirmDelete(file);
            }
            
            hideContextMenu();
        }

        function confirmDelete(file) {
            showModal(`
                <div class="text-center">
                    <i class="fa fa-exclamation-triangle text-yellow-500 text-4xl mb-4"></i>
                    <h3 class="text-xl font-bold mb-2">确认删除</h3>
                    <p class="text-gray-400 mb-4">确定要删除 "${file.name}" 吗？此操作无法撤销。</p>
                    <div class="flex gap-2">
                        <button id="cancelDelete" class="flex-1 neumorph bg-dark hover:bg-dark/70 transition-colors rounded-lg p-2">取消</button>
                        <button id="confirmDelete" class="flex-1 neumorph bg-error hover:bg-error/80 transition-colors rounded-lg p-2 text-white">删除</button>
                    </div>
                </div>
            `);
            
            document.getElementById('cancelDelete').addEventListener('click', hideModal);
            document.getElementById('confirmDelete').addEventListener('click', () => {
                deleteFile(file);
                hideModal();
            });
        }

        async function deleteFile(file) {
            if (!state.currentRepo || !file.sha) return;
            
            try {
                const url = `https://api.github.com/repos/${state.currentRepo}/contents/${state.currentPath ? state.currentPath + '/' : ''}${file.name}`;
                
                const res = await fetchWithRateLimit(url, {
                    method: 'DELETE',
                    headers: {
                        Authorization: `token ${state.token}`,
                        'Content-Type': 'application/json',
                        'User-Agent': 'Mozilla/5.0'
                    },
                    body: JSON.stringify({
                        message: `Delete ${file.name}`,
                        sha: file.sha
                    })
                });
                
                if (!res.ok) {
                    throw new Error('删除失败');
                }
                
                showToast('文件已删除');
                fetchFiles();
            } catch (err) {
                showToast('删除失败');
                console.error(err);
            }
        }

        function showModal(content) {
            elements.modalContent.innerHTML = content;
            elements.modalOverlay.classList.remove('hidden');
            elements.modalOverlay.classList.add('flex');
        }

        function hideModal() {
            elements.modalOverlay.classList.add('hidden');
            elements.modalOverlay.classList.remove('flex');
        }

        function showToast(message) {
            elements.toastMessage.textContent = message;
            elements.toast.classList.remove('hidden');
            
            setTimeout(() => {
                elements.toast.classList.add('hidden');
            }, 3000);
        }

        function setupEventListeners() {
            elements.authBtn.addEventListener('click', async () => {
                const token = elements.tokenInput.value.trim();
                if (!token) {
                    showToast('请输入访问令牌');
                    return;
                }
                
                try {
                    const res = await fetch('https://api.github.com/user', {
                        headers: {
                            Authorization: `token ${token}`,
                            'User-Agent': 'Mozilla/5.0'
                        }
                    });
                    
                    if (!res.ok) {
                        throw new Error('令牌无效');
                    }
                    
                    localStorage.setItem('gh_token', token);
                    state.token = token;
                    showApp();
                    fetchRepos();
                } catch (err) {
                    showToast('令牌无效');
                    console.error(err);
                }
            });

            elements.logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('gh_token');
                state.token = null;
                state.currentRepo = null;
                state.currentPath = '';
                showAuth();
            });

            elements.backBtn.addEventListener('click', () => {
                if (!state.currentPath) return;
                
                const lastSlashIndex = state.currentPath.lastIndexOf('/');
                if (lastSlashIndex === -1) {
                    state.currentPath = '';
                } else {
                    state.currentPath = state.currentPath.substring(0, lastSlashIndex);
                }
                
                showLoading();
                renderPathNav();
                fetchFiles();
            });

            elements.refreshBtn.addEventListener('click', () => {
                showLoading();
                fetchFiles();
            });

            elements.repoBtn.addEventListener('click', showRepoSelectModal);
            elements.closeRepoModal.addEventListener('click', hideRepoSelectModal);

            elements.closeEditModal.addEventListener('click', hideEditModal);
            elements.cancelEdit.addEventListener('click', hideEditModal);
            elements.saveEdit.addEventListener('click', saveFileChanges);

            elements.newFolderBtn.addEventListener('click', () => {
                showModal(`
                    <div>
                        <h3 class="text-xl font-bold mb-4">新建文件夹</h3>
                        <input type="text" id="newFolderName" placeholder="文件夹名称" 
                            class="neumorph-inset bg-darker rounded-lg p-3 outline-none text-light w-full mb-4">
                        <div class="flex gap-2">
                            <button id="cancelNewFolder" class="flex-1 neumorph bg-dark hover:bg-dark/70 transition-colors rounded-lg p-2">取消</button>
                            <button id="confirmNewFolder" class="flex-1 neumorph bg-primary hover:bg-secondary transition-colors rounded-lg p-2">创建</button>
                        </div>
                    </div>
                `);
                
                const input = document.getElementById('newFolderName');
                input.focus();
                
                document.getElementById('cancelNewFolder').addEventListener('click', hideModal);
                document.getElementById('confirmNewFolder').addEventListener('click', () => {
                    const folderName = input.value.trim();
                    if (folderName) {
                        createNewFolder(folderName);
                        hideModal();
                    } else {
                        showToast('请输入文件夹名称');
                    }
                });
            });

            elements.uploadBtn.addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.multiple = true;
                input.onchange = (e) => {
                    if (e.target.files.length > 0) {
                        uploadFiles(e.target.files);
                    }
                };
                input.click();
            });

            document.addEventListener('click', (e) => {
                if (!elements.contextMenu.contains(e.target)) {
                    hideContextMenu();
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    hideContextMenu();
                    hideModal();
                    hideEditModal();
                    hideRepoSelectModal();
                }
            });

            elements.fileContent.addEventListener('input', () => {
                if (elements.fileContent.value !== state.originalContent) {
                    elements.editStatus.textContent = '未保存的更改';
                    elements.editStatus.className = 'status bg-modifiedLight text-modified';
                } else {
                    elements.editStatus.textContent = '准备就绪';
                    elements.editStatus.className = 'status bg-dark';
                }
            });
        }

        async function createNewFolder(folderName) {
            if (!state.currentRepo) return;
            
            try {
                const path = state.currentPath ? `${state.currentPath}/${folderName}` : folderName;
                const url = `https://api.github.com/repos/${state.currentRepo}/contents/${path}`;
                
                const res = await fetchWithRateLimit(url, {
                    method: 'PUT',
                    headers: {
                        Authorization: `token ${state.token}`,
                        'Content-Type': 'application/json',
                        'User-Agent': 'Mozilla/5.0'
                    },
                    body: JSON.stringify({
                        message: `Create folder ${folderName}`,
                        content: ''
                    })
                });
                
                if (!res.ok) {
                    throw new Error('创建文件夹失败');
                }
                
                showToast('文件夹已创建');
                fetchFiles();
            } catch (err) {
                showToast('创建文件夹失败');
                console.error(err);
            }
        }

        function uploadFiles(files) {
            if (!state.currentRepo || files.length === 0) return;
            
            state.uploadQueue = Array.from(files);
            elements.uploadPanel.classList.remove('hidden');
            elements.uploadItems.innerHTML = '';
            
            state.uploadQueue.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'space-y-1';
                item.innerHTML = `
                    <div class="flex justify-between text-sm">
                        <span class="truncate max-w-[70%]">${file.name}</span>
                        <span class="upload-percentage">0%</span>
                    </div>
                    <div class="upload-progress">
                        <div class="upload-bar" data-index="${index}"></div>
                    </div>
                `;
                elements.uploadItems.appendChild(item);
            });
            
            processUploadQueue();
        }

        async function processUploadQueue() {
            if (state.uploadQueue.length === 0) {
                setTimeout(() => {
                    elements.uploadPanel.classList.add('hidden');
                }, 1000);
                return;
            }
            
            const file = state.uploadQueue[0];
            const index = state.uploadQueue.length - 1;
            
            try {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const content = e.target.result.split(',')[1];
                    const fileName = file.name;
                    const path = state.currentPath ? `${state.currentPath}/${fileName}` : fileName;
                    const url = `https://api.github.com/repos/${state.currentRepo}/contents/${path}`;
                    
                    try {
                        const res = await fetchWithRateLimit(url, {
                            method: 'PUT',
                            headers: {
                                Authorization: `token ${state.token}`,
                                'Content-Type': 'application/json',
                                'User-Agent': 'Mozilla/5.0'
                            },
                            body: JSON.stringify({
                                message: `Upload ${fileName}`,
                                content: content
                            })
                        });
                        
                        if (!res.ok) {
                            throw new Error('上传失败');
                        }
                        
                        document.querySelector(`.upload-bar[data-index="${index}"]`).style.width = '100%';
                        document.querySelector(`.upload-percentage`).textContent = '100%';
                        state.uploadQueue.shift();
                        showToast(`文件 "${fileName}" 上传成功`);
                        fetchFiles();
                        processUploadQueue();
                    } catch (err) {
                        showToast(`文件 "${fileName}" 上传失败`);
                        console.error(err);
                        state.uploadQueue.shift();
                        processUploadQueue();
                    }
                };
                
                reader.readAsDataURL(file);
                
                const updateProgress = () => {
                    if (!state.uploadQueue.includes(file)) return;
                    
                    const progress = Math.min(95, Math.random() * 100);
                    document.querySelector(`.upload-bar[data-index="${index}"]`).style.width = `${progress}%`;
                    document.querySelector(`.upload-percentage`).textContent = `${Math.round(progress)}%`;
                    
                    if (progress < 95) {
                        setTimeout(updateProgress, 500);
                    }
                };
                
                updateProgress();
            } catch (err) {
                console.error(err);
                state.uploadQueue.shift();
                processUploadQueue();
            }
        }

        async function fetchWithRateLimit(url, options = {}) {
            const now = Date.now();
            const timeSinceLastRequest = now - state.lastRequestTime;
            
            if (timeSinceLastRequest < state.MIN_INTERVAL) {
                await new Promise(resolve => setTimeout(resolve, state.MIN_INTERVAL - timeSinceLastRequest));
            }
            
            state.lastRequestTime = Date.now();
            return fetch(url, options);
        }

        function showLoading() {
            elements.loadingOverlay.classList.remove('hidden');
            elements.loadingOverlay.classList.add('flex');
        }

        function hideLoading() {
            elements.loadingOverlay.classList.add('hidden');
            elements.loadingOverlay.classList.remove('flex');
        }
    </script>
</body>
</html>
